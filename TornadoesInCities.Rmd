---
title: "Tornadoes in Cities"
output: html_document
editor_options: 
  chunk_output_type: console
---

What cities have seen the biggest change in tornado frequency before/after 1985? Here I divide the tornado record into two epochs: 1985-2019 and 1950-1984 and then count the number of tornadoes within each core-based statistical area.

Load packages.
```{r}
library(sf)
library(tidyverse)
library(tidycensus)
```

Get USA boundary map from {tidycensus}.
```{r}
data(state_laea)
```

The Core-Based Statistical Areas (CBSA) are geographic locations neighboring urban areas of 10,000+ population and/or are socioeconomically tied to the urban center by commute proximity. Prior to the year 2000, these were collectively known as MSA- Metropolitan Statistical Areas and Micropolitan Statistical Areas. An exclusive feature of GreatData CBSA Data is that the population statistics are calculated annually. Therefore, the CBSA rank is based on a more recent population than typical census data classifications.

https://catalog.data.gov/dataset/tiger-line-shapefile-2019-nation-u-s-current-metropolitan-statistical-area-micropolitan-statist https://www2.census.gov/geo/tiger/TIGER2019/CBSA/tl_2019_us_cbsa.zip

Get the CBSA polygons.
```{r}
if(!"tl_2019_us_cbsa" %in% list.files()){
unzip("tl_2019_us_cbsa.zip",
      exdir = "tl_2019_us_cbsa")
}

CBSA.sf <- read_sf(dsn = "tl_2019_us_cbsa", 
                   layer = "tl_2019_us_cbsa") %>%
  st_transform(crs = st_crs(state_laea))
```

Get the tornado tracks. Tracks that recorded at least EF2 damage somewhere.
```{r}
if(!"1950-2019-torn-aspath" %in% list.files()) {
download.file(url = "http://www.spc.noaa.gov/gis/svrgis/zipped/1950-2019-torn-aspath.zip",
              destfile = "1950-2019-torn-aspath.zip")
unzip("1950-2019-torn-aspath.zip")
}

Torn.sf <- st_read(dsn = "1950-2019-torn-aspath", 
                   layer = "1950-2019-torn-aspath") %>%
  st_transform(crs = st_crs(state_laea)) %>%
  mutate(Late = yr >= 1985) %>%
  filter(mag >= 2)
```

Create a map showing one CBSA and the intersecting tornado tracks.
```{r}
NameC <- "Atlanta-Sandy Springs-Alpharetta, GA"
Area.sf <- CBSA.sf %>%
  filter(NAME == NameC)

State.sf <- state_laea %>%
  filter(GEOID == "13")

Intersects <- Area.sf %>%
  st_intersects(Torn.sf) %>%
  unlist()

AreaTors.sf <- Torn.sf[Intersects, ]

nT <- AreaTors.sf %>%
  group_by(Late) %>%
  summarize(nT = n()) %>%
  pull(nT)

ggplot() +
  geom_sf(data = State.sf, fill = "white") +
  geom_sf(data = Area.sf, color = "gray70") +
  geom_sf(data = AreaTors.sf, color = "red") +
  labs(title = paste0("Estimated tracks of significant tornadoes across ", NameC),
       subtitle = paste0("Total numbers: 1950-1984: ", nT[1], paste0(", 1985-2019: ", nT[2])))

```

All metro areas. Also see {stars.Rmd} for creating a space-time object.
```{r}
Intersects <- CBSA.sf %>%
  st_intersects(Torn.sf) %>%
  unlist()
AreaTors.sf <- Torn.sf[Intersects, ]

Intersects.m <- CBSA.sf %>%
  st_intersects(Torn.sf, sparse = FALSE)

TorCounts.sf <- 
  data.frame(GEOID = CBSA.sf$GEOID, 
             NAME = CBSA.sf$NAME,
             nT = rowSums(Intersects.m),
             geometry = CBSA.sf$geometry) %>%
  st_as_sf()
```

```{r}
TorCounts.sf %>%
  arrange(desc(nT))

TorCounts.sf %>%
  slice_max(nT, n = 25) %>%
  ggplot(mapping = aes(y = reorder(NAME, nT), x = nT)) +
  geom_point(size = 2, colour = "black", aes(color = )) + 
  geom_segment(mapping = aes(yend = NAME, xend = 0), size = 1)+
  labs(y= "", x = "") +
  theme_minimal()
```

```{r}
library(patchwork)

Top25.sf <- TorCounts.sf %>%
  slice_max(nT, n = 25)

( US_map <- ggplot(data = state_laea) +
  geom_sf(fill = 'gray30') +
  geom_sf(data = Top25.sf, size = 0,
          mapping = aes(fill = nT)) + 
  scale_fill_distiller(palette = "Greens",
                       direction = 1, 
                       guide = FALSE) + 
  theme_dark() )

( P_plot <- ggplot(data = Top25.sf, 
                   mapping = aes(x = nT, y = reorder(NAME, nT), color = nT)) +
  geom_point(size = 2) +
  scale_color_distiller(palette = "Greens",
                        direction = 1, 
                        guide = FALSE) + 
  scale_x_continuous(limits = c(0, NA)) +
  labs(title = "Top 25 Metropolitan Areas by Number of Significant Tornadoes",
       subtitle = "1950-2019",
       y = "", x = "") + 
  theme_dark() )

P_plot / US_map
```

Create a link/hover with map. https://twitter.com/kyle_e_walker/status/1397530708218892293 https://gist.github.com/walkerke/3628171efae66421c299c9f2dbee0f34

```{r}
library(ggiraph)

( US_map <- ggplot(data = state_laea) +
  geom_sf(fill = 'gray30') +
  geom_sf_interactive(data = Top25.sf, size = 0,
                      mapping = aes(fill = nT, data_id = GEOID)) + 
  scale_fill_distiller(palette = "Greens",
                       direction = 1, 
                       guide = FALSE) + 
  theme_dark() )

( P_plot <- ggplot(data = Top25.sf, 
                   mapping = aes(x = nT, y = reorder(NAME, nT), color = nT)) +
  geom_point_interactive(size = 2, mapping = aes(data_id = GEOID)) +
  scale_x_continuous(limits = c(0, NA)) +
  labs(title = "Top 25 Metropolitan Areas by Number of Significant Tornadoes",
       subtitle = "1950-2019",
       y = "", x = "") + 
  theme_dark() )

girafe(ggobj = P_plot / US_map, width_svg = 10, height_svg = 6) %>%
  girafe_options(opts_hover(css = "fill:cyan;"))
```

Counts grouped early and late
```{r}
TorCounts.df <- Torn.sf %>%
  st_intersection(MSA.sf) %>%
  st_drop_geometry() %>%
  group_by(GEOID, EarlyLate) %>%
  summarize(nT = n()) %>%
  ungroup()

( Diff.df <- TorCounts.df %>%
  pivot_wider(names_from = EarlyLate, 
              values_from = nT) %>%
  rename(After1985 = `FALSE`,
         Before1985 = `TRUE`) %>%
  mutate(Difference = After1985 - Before1985,
         DiffPerc = Difference/Before1985 * 100) %>%
  drop_na() )

sum(Diff.df$Difference > 0)
sum(Diff.df$Difference < 0)
```

Top 10 and bottom 10 combined.
```{r}
Upward <- Diff.df %>%
  slice_max(Difference, n = 10) %>%
  mutate(Tendency = "Upward")

Downward <- Diff.df %>%
  slice_min(Difference, n = 10) %>%
  mutate(Tendency = "Downward")

Both <- rbind(Upward, Downward)

Both <- Both %>%
  left_join(MSA.sf,
            by = "GEOID") 
```

Plot a slope graph.
```{r}
library(ggrepel)

ggplot(Both) +
  geom_segment(mapping = aes(x = .4, xend = .6, 
                             y = Before1985, yend = After1985, 
                             color = Tendency)) +
  scale_color_brewer(palette = "Paired", guide = FALSE) +
  scale_x_continuous(limits = c(0, 1)) +
  theme(panel.background = element_blank(),
        panel.grid=element_blank(),
        axis.ticks=element_blank(),
        axis.text=element_blank(),
        panel.border=element_blank()) +
  xlab("") + ylab("") +
  geom_text(data = Both[Both$Tendency == "Upward", ],
            mapping = aes(x = .62, y = After1985, 
                          label = paste(After1985, NAME, sep = "   ")), hjust = 0, size = 2.3) +
  geom_text(data = Both[Both$Tendency == "Downward", ], 
            mapping = aes(x = .38, y = Before1985, 
                          label = paste(NAME, Before1985, sep = "   ")), hjust = 1, size = 2.3) +
  geom_text(data = Both[1, ], 
            mapping = aes(label = "1950-1984", x = .38, y = 1), hjust = 1, size = 3) +
  geom_text(data = Both[1, ], 
            mapping = aes(label = "1985-2018", x = .62, y = 1), hjust = 0, size = 3) +
  geom_segment(data = Both[1,],
               mapping = aes(x = .45, y = 1, xend = .55, yend = 1),
               arrow = arrow(angle = 20, length = unit(2, "mm"), type = "closed")) +
  ggtitle(label = "The shifting tornado threat", 
          subtitle = "Cities with the largest change (top 10 increases & decreases) in the number of strong (EF2+ damage) tornadoes before/after 1985")
```

Create a link/hover with map. https://twitter.com/kyle_e_walker/status/1397530708218892293 https://gist.github.com/walkerke/3628171efae66421c299c9f2dbee0f34

```{r}
library(ggiraph)
library(patchwork)

Both <- Both %>%
  select(GEOID, After1985, Before1985, Difference)

Both.sf <- MSA.sf %>%
  right_join(Both,
            by = "GEOID") 

( US_map <- ggplot(state_laea) +
  geom_sf() +
  geom_sf_interactive(data = Both.sf, 
                      aes(fill = Difference > 0, data_id = GEOID)) + 
#  scale_fill_distiller(palette = "RdBu",
#                       direction = -1, 
#                       guide = FALSE) + 
  scale_fill_manual(values = c("#E69F00", "#CC79A7"),
                    guide = FALSE) +
  theme_void() )

( Point_plot <- ggplot(Both.sf, aes(x = Difference, y = reorder(NAME, Difference), 
                                    fill = Difference > 0)) +
  geom_point_interactive(size = 2.5, shape = 21,
                         aes(data_id = GEOID)) +
#  scale_fill_distiller(palette = "RdBu", 
#                       direction = -1,
#                       guide = FALSE) + 
  scale_fill_manual(values = c("#E69F00", "#CC79A7"),
                      guide = FALSE) +
  scale_x_continuous(limits = c(-75, 25)) +
  labs(title = "Top Differences in Tornado Counts",
       subtitle = "After Minus Before 1985",
       y = "",
       x = "") + 
  theme_minimal() )

x <- girafe(ggobj = Point_plot / US_map, width_svg = 12, height_svg = 8) %>%
  girafe_options(opts_hover(css = "fill:cyan;"))

if(interactive()){
  print(x)
}

```

